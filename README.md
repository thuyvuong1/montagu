# Montagu
## Prerequisites
* [Docker Community Edition](https://docs.docker.com/engine/installation/) 
* [Docker Compose](https://docs.docker.com/compose/install/) - at least version 0.17.0
* Python 3 and pip (Python 3 is included with Ubunti. For pip, use `apt install python3-pip`)
* [Vault](https://www.vaultproject.io/downloads.html) available on the command line as `vault`, with the address set via `export VAULT_ADDR=https://support.montagu.dide.ic.ac.uk:8200`
* Your machine needs to trust our Docker Registry. See 
  ["Configuring docker clients to use the registry"](https://github.com/vimc/montagu-ci#configuring-docker-clients-to-use-the-registry)

## Other docs process
* [Release process](ReleaseProcess.md)
* [Disaster recovery](docs/DisasterRecovery.md)
* Upgrading and rebooting servers: [docs](docs/)

## Deploy
As root:

1. `(cd src && pip3 install --user -r requirements.txt)`
2. `./src/deploy.py`

### Deploy a specific version

```
./deploy.py v0.1.2
```

If the version number is omitted the script will prompt you for one (it must match the pattern of `vX.Y.Z-RCa` where `X`, `Y`, `Z` and `a` are one or more digits.

### Use dockerhub containers
We also have all our released images on [docker hub](https://hub.docker.com/u/vimc/dashboard/) and the deploy tool can work from there.  This requires VPN access only for the vault, so for test deployments can be done off-site more easily.

```
./deploy.py --docker-hub <version>
```

### Settings
The deploy tool will ask you a series of questions interactively, suggesting
defaults along the way. These settings are saved to `./src/montagu-deploy.json`
and on the next deploy those questions will not be asked. If new settings are
added to the deploy tool, you will just be asked the new questions on your next
deploy.

If you change your mind, you can directly change the values in the json file,
delete the setting in question from the json file (prompting the tool to ask
you just that question again next time you deploy) or delete the whole json file
and go through the full interactive setup again.

#### Test users
If you use the 'test_data' data set then it comes with a default username 
("test.user@imperial.ac.uk") and password ("password")

When deploying to a testing environment using real data restored from live, 
setting the `add_test_user` option to true adds the above user with permissions 
to all modelling groups and reports.

### Root privileges
When deploying to the live server, make sure to first become the root user by 
running `sudo su`. This is neccessary to have the correct environment variables 
for the backup to run.

### Backup
If you set the initial data source to "restore", or you enable backups, the 
deploy tool will automatically configure our 
[backup tool](https://github.com/vimc/montagu-backup). To do so, it needs to
obtain an encryption key from the Vault. Once this has run once, the encryption
key and backup settings are saved to `/etc/montagu/backup`. Upon future runs of
the deploy tool, backup configuration will be skipped (using 
`backup/needs-setup.sh` as the test). If you know something has changed and you
want to force a rerun, delete the existing configuration 
(`sudo rm -r /etc/montagu/backup`).

### Database restore

The database can be restored without redeploying all of montagu.

```
sudo -E ./src/restore_db.py
```

(The `sudo` is required because the backup scripts require it, and the `-E` allows the `sudo` shell to read your vault credentials.)

This can be setup as a cron job to run every night (as is on `science`) by adding a file containing

```
0 6 * * * root /home/vagrant/montagu/restore_db.py
```

as `/etc/cron.d/montagu-restore-db`.

However, care should be taken here because if the schema has been migrated in the production database the montagu api may not be able to talk to the database.  In practice this is probably not that much of a problem as we can just redeploy (and often will have deployed on science before deploying on production).

## Passwords

Database passwords are managed by the vault and laid out as:

```
/secret/database/:password_group/users/:username
```

Currently our two password groups are `science` and `production`

### Retrieve

To get a database password for use with postgres

```
export PGPASSWORD=$(vault read -field=password secret/database/science/users/readonly)
psql -h support.montagu.dide.ic.ac.uk -U readonly -d montagu
```

This gets the password for the `readonly` user for the `science` password group (which is suitable for the database running on support.montagu.dide.ic.ac.uk). To see all users, use:

```
vault list secret/database/science/users
```

or

```
vault list secret/database/production/users
```

### Add a new user

Run

```
./src/generate_passwords.py add_user <username>
```

Passwords can be regenerated by running the script

```
generate_passwords.py regenerate_passwords <group>
```

which will regenerate passwords for one of the password groups.  To create a new password group, use

```
./src/generate_passwords.py create_password_group [--base=BASE] <name>
```

which generates a new set of passwords for the same users as the group specified by `--base` (defaulting to science).

## Development
To update `src/versions.py` to the latest master of each sub repo, use 
`src/update_versions_to_latest_master.py`.

## Logging

We log to systemd.  All logs will have the tag `DOCKER_TAG=montagu` which allows for filtering with

```
journalctl --since=today CONTAINER_TAG=montagu
journalctl --since=today CONTAINER_NAME=montagu_db_1
```

## Release

See [`ReleaseProcess.md`(ReleaseProcess.md) for details on releasing
