# Deployment notes

Notes from Rich about the deployment on 18 August 2017.  This is a fairly complex set of fiddling on top of the main deployment process in order to deal with:

* non-legacy-data import (from montagu-data)
* perform the modified update (via orderly) and upload to the db
* run a series of reports


For support

```
ssh support.montagu
sudo su vagrant
cd ~vagrant/staging/staging
vagrant ssh science
```

For production it's a bit simpler

```
ssh production.montagu
sudo su
```

To get things from private repos (montagu-data) I used vimc-robot's keys with

```
export VAULT_ADDR='https://support.montagu.dide.ic.ac.uk:8200'
export VAULT_AUTH_GITHUB_TOKEN=...
vault auth -method=github
mkdir -p ~/.ssh
vault read -field=value secret/vimc-robot/id_rsa > ~/.ssh/id_rsa
vault read -field=value secret/vimc-robot/id_rsa.pub > ~/.ssh/id_rsa.pub
chmod 600 ~/.ssh/id_rsa
```

Clone down some repos with

```
git clone https://github.com/vimc/montagu-orderly
git clone git@github.com:vimc/montagu-data
cd montagu # /montagu/deploy on production
git checkout -b i487 origin/i487
```

don't forget `docker volume prune` - we are starting from scratch here.

* deploy: `./src/deploy.py`
* finish data import: in `montagu-data`, run `./build_montagu.sh`
* set up orderly: `setup/orderly.sh`

* add me as a user:
   - `./src/cli.py add`
   - `./src/cli.py addRole rich user`
   - `./src/cli.py addRole rich reports-reviewer`
(for testing I used)
   - `./src/cli.py add`
      - testing
      - testing
      - testing@imperial.ac.uk
      - password
   - `./src/cli.py addRole testing user`
   - `./src/cli.py addRole testing reports-reviewer`


* Test orderly: `../montagu-orderly/orderly_montagu.sh list names`

* `../montagu-orderly/orderly_montagu.sh` (orderly commands)
* `../montagu-orderly/orderly_montagu_sh.sh` (arbitrary commands, e.g. bash)

So

```
../montagu-orderly/orderly_montagu.sh run modup-201707
ID=$(../montagu-orderly/orderly_montagu.sh latest modup-201707)
../montagu-orderly/orderly_montagu.sh publish $ID
```

Then we need to upload the data into the database.  That's a total faff.

```
../montagu-orderly/orderly_montagu_sh.sh R
id <- "20170817-170825-d8220937"
con <- orderly::orderly_db("source")
path <- file.path("archive/modup-201707", id)
source(file.path(path, "R", "upload.R"))
source(file.path(path, "R", "util.R"))
dat <- readRDS(file.path(path, "modified_update_201707.rds"))
modified_update_upload(con, dat, 1L)
```

Once that's all done things are more or less ready to go

```
../montagu-orderly/orderly_montagu.sh run modup-201707-report
../montagu-orderly/orderly_montagu.sh publish <id from above>
../montagu-orderly/orderly_montagu.sh run modup-201707-diagnostics
../montagu-orderly/orderly_montagu.sh run modup-201707-queries1
```
